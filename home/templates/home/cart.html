{% extends 'base.html' %}
{% load static %}

{% block body %}

<style>
  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ù…Ø© - Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
  .cart-container {
    background-color: #000000;
    direction: rtl;
    text-align: center;
    padding: 30px 15px;
    min-height: 70vh;
  }

  .cart-title {
    color: #c19d56;
    margin-bottom: 30px;
    font-size: 32px;
    font-weight: 700;
    text-shadow: 0 0 10px rgba(193, 157, 86, 0.3);
  }

  /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© - Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
  .cart-table {
    background: #1a1a1a;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(193, 157, 86, 0.3);
    border: 2px solid #c19d56;
  }

  .cart-table thead {
    background-color: #c19d56;
    color: #000000;
  }

  .cart-table th {
    font-weight: 700;
    padding: 15px 10px;
    border: none;
  }

  .cart-table td {
    padding: 15px 10px;
    vertical-align: middle;
    color: #c19d56;
    border-color: rgba(193, 157, 86, 0.2);
  }

  .cart-table tbody tr {
    border-bottom: 1px solid rgba(193, 157, 86, 0.2);
  }

  /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙ…ÙŠØ© */
  .quantity-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }

  .quantity-btn {
    width: 30px;
    height: 30px;
    border: 1px solid #c19d56;
    background: #000000;
    color: #c19d56;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 700;
  }

  .quantity-btn:hover {
    background: #c19d56;
    color: #000000;
    box-shadow: 0 0 8px rgba(193, 157, 86, 0.5);
  }

  .quantity-value {
    min-width: 40px;
    font-weight: 600;
    color: #c19d56;
  }

  /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
  .action-buttons {
    margin-top: 30px;
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-custom {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s;
  }

  .btn-outline-custom {
    border: 2px solid #c19d56;
    color: #c19d56;
    background: transparent;
  }

  .btn-outline-custom:hover {
    background: #c19d56;
    color: #000000;
    box-shadow: 0 0 10px rgba(193, 157, 86, 0.5);
  }

  .btn-primary-custom {
    background-color: #c19d56;
    color: #000000;
    border: none;
    font-weight: 700;
  }

  .btn-primary-custom:hover {
    background-color: #d4b06a;
    box-shadow: 0 0 10px rgba(193, 157, 86, 0.5);
  }

  /* Ø²Ø± Ø§Ù„Ø­Ø°Ù */
  .btn-danger {
    background-color: #dc3545;
    border: none;
    color: white;
    transition: all 0.3s;
  }

  .btn-danger:hover {
    background-color: #c82333;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
  }

  /* Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© ÙˆØ§Ù„ØµØºÙŠØ±Ø© */
  @media (max-width: 992px) {
    .cart-title {
      font-size: 28px;
    }

    .cart-table th,
    .cart-table td {
      padding: 10px 5px;
      font-size: 14px;
    }

    .btn-custom {
      padding: 10px 20px;
      font-size: 14px;
    }
  }

  /* Ù„Ù„Ù‡ÙˆØ§ØªÙ - ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª */
  @media (max-width: 768px) {
    .cart-title {
      font-size: 24px;
      margin-bottom: 20px;
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ */
    .desktop-table {
      display: none;
    }

    /* Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .mobile-cards {
      display: block;
    }

    .cart-card {
      background: #1a1a1a;
      border: 2px solid #c19d56;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(193, 157, 86, 0.3);
    }

    .cart-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(193, 157, 86, 0.3);
    }

    .cart-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #c19d56;
      margin: 0;
    }

    .cart-card-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .cart-card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .cart-card-label {
      font-weight: 600;
      color: #c19d56;
      font-size: 14px;
    }

    .cart-card-value {
      font-weight: 600;
      color: #d4b06a;
      font-size: 14px;
    }

    .cart-card-footer {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid rgba(193, 157, 86, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cart-card-total {
      font-size: 18px;
      font-weight: 700;
      color: #c19d56;
    }

    .btn-remove-mobile {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-remove-mobile:hover {
      background-color: #c82333;
      box-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
    }

    .action-buttons {
      flex-direction: column;
      width: 100%;
      padding: 0 15px;
    }

    .btn-custom {
      width: 100%;
      max-width: 550px;
    }

    .total-section {
      background: #1a1a1a;
      border: 2px solid #c19d56;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 15px;
      box-shadow: 0 2px 10px rgba(193, 157, 86, 0.3);
    }

    .total-section h4 {
      font-size: 20px;
      margin: 0;
      color: #c19d56;
    }
  }

  /* Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
  @media (min-width: 769px) {
    .mobile-cards {
      display: none;
    }

    .desktop-table {
      display: table;
    }

    .total-section {
      background: #1a1a1a;
      border: 2px solid #c19d56;
      padding: 20px;
      border-radius: 12px;
      margin: 20px auto;
      box-shadow: 0 2px 10px rgba(193, 157, 86, 0.3);
      max-width: 600px;
    }

    .total-section h4 {
      color: #c19d56;
      font-size: 24px;
    }
  }

  /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙØ§Ø±ØºØ© */
  .empty-cart {
    padding: 60px 20px;
  }

  .empty-cart p {
    color: #c19d56;
    font-size: 18px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .empty-cart {
      padding: 40px 20px;
    }

    .empty-cart p {
      font-size: 16px;
    }
  }
</style>

<div class="cart-container">

  <h2 class="cart-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h2>

  {% if cart_items %}
    <div class="container">
      
      <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
      <table class="table table-bordered text-center cart-table desktop-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ø³Ø¹Ø©</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart_items %}
            <tr id="item-row-{{ item.id }}">
              <td>{{ item.perfume_size.perfume.name_ar }}</td>
              <td>{{ item.perfume_size.size_ml }} Ù…Ù„</td>
              <td>
                <div class="quantity-controls">
                  <button class="quantity-btn update-quantity" data-action="decrease" data-item-id="{{ item.id }}">-</button>
                  <span class="quantity-value" id="quantity-{{ item.id }}">{{ item.quantity }}</span>
                  <button class="quantity-btn update-quantity" data-action="increase" data-item-id="{{ item.id }}">+</button>
                </div>
              </td>
              <td id="item-total-{{ item.id }}">{{ item.total_price }} Ø¬Ù†ÙŠÙ‡</td>
              <td>
                <button class="btn btn-sm btn-danger remove-item" data-item-id="{{ item.id }}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ù‡ÙˆØ§ØªÙ -->
      <div class="mobile-cards">
        {% for item in cart_items %}
          <div class="cart-card" id="item-card-{{ item.id }}">
            <div class="cart-card-header">
              <h3 class="cart-card-title">{{ item.perfume_size.perfume.name_ar }}</h3>
            </div>
            
            <div class="cart-card-body">
              <div class="cart-card-row">
                <span class="cart-card-label">Ø§Ù„Ø³Ø¹Ø©:</span>
                <span class="cart-card-value">{{ item.perfume_size.size_ml }} Ù…Ù„</span>
              </div>
              
              <div class="cart-card-row">
                <span class="cart-card-label">Ø§Ù„ÙƒÙ…ÙŠØ©:</span>
                <div class="quantity-controls">
                  <button class="quantity-btn update-quantity" data-action="decrease" data-item-id="{{ item.id }}">-</button>
                  <span class="quantity-value" id="quantity-mobile-{{ item.id }}">{{ item.quantity }}</span>
                  <button class="quantity-btn update-quantity" data-action="increase" data-item-id="{{ item.id }}">+</button>
                </div>
              </div>
            </div>
            
            <div class="cart-card-footer">
              <span class="cart-card-total" id="item-total-mobile-{{ item.id }}">{{ item.total_price }} Ø¬Ù†ÙŠÙ‡</span>
              <button class="btn-remove-mobile remove-item" data-item-id="{{ item.id }}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="total-section">
        <h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="total-price" style="color: #c19d56;">{{ total_price }} Ø¬Ù†ÙŠÙ‡</span></h4>
      </div>

      <div class="action-buttons">
        <a href="{% url 'home:home' %}" class="btn btn-custom btn-outline-custom">Ø­Ø¬Ø² Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</a>
        <a href="{% url 'home:booking' %}" class="btn btn-custom btn-primary-custom">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²</a>
      </div>
    </div>
  {% else %}
    <div class="empty-cart">
      <p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
      <a href="{% url 'home:home' %}" class="btn btn-custom btn-primary-custom">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    </div>
  {% endif %}

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©
    $('.update-quantity').click(function() {
      const itemId = $(this).data('item-id');
      const action = $(this).data('action');
      
      $.ajax({
        url: "{% url 'home:update_cart_quantity' %}",
        method: "POST",
        data: {
          'item_id': itemId,
          'action': action,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(data) {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ø¹Ø±Ø¶ÙŠÙ†
          $(`#quantity-${itemId}`).text(data.new_quantity);
          $(`#quantity-mobile-${itemId}`).text(data.new_quantity);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ø¹Ø±Ø¶ÙŠÙ†
          $(`#item-total-${itemId}`).text(data.item_total + " Ø¬Ù†ÙŠÙ‡");
          $(`#item-total-mobile-${itemId}`).text(data.item_total + " Ø¬Ù†ÙŠÙ‡");
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
          $('#total-price').text(data.total_price + " Ø¬Ù†ÙŠÙ‡");

          // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ø°Ø§ Ø£ØµØ¨Ø­Øª Ø§Ù„ÙƒÙ…ÙŠØ© ØµÙØ±
          if (data.new_quantity === 0) {
            $(`#item-row-${itemId}`).fadeOut(300, function() {
              $(this).remove();
            });
            $(`#item-card-${itemId}`).fadeOut(300, function() {
              $(this).remove();
            });
          }
        }
      });
    });

    // âœ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    $('.remove-item').click(function() {
      const itemId = $(this).data('item-id');
      
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
        $.ajax({
          url: "{% url 'home:remove_cart_item' %}",
          method: "POST",
          data: {
            'item_id': itemId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function(data) {
            // Ø­Ø°Ù Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„Ø¹Ø±Ø¶ÙŠÙ†
            $(`#item-row-${itemId}`).fadeOut(300, function() {
              $(this).remove();
            });
            $(`#item-card-${itemId}`).fadeOut(300, function() {
              $(this).remove();
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            $('#total-price').text(data.total_price + " Ø¬Ù†ÙŠÙ‡");
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ Ø£ØµØ¨Ø­Øª Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©
            if (data.total_price === 0) {
              setTimeout(function() {
                location.reload();
              }, 400);
            }
          }
        });
      }
    });

  });
</script>
{% endblock body %}