{% extends 'base.html' %}
{% load static %}

{% block body %}
<div style="background-color: #f9f9f9; direction: rtl; text-align: center; padding: 30px;">

  <h2 style="color: #c19d56; margin-bottom: 30px;">ğŸ›’ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h2>

  {% if cart_items %}
    <div class="container">
      <table class="table table-bordered text-center" style="background: white;">
        <thead style="background-color: #c19d56; color: white;">
          <tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ø³Ø¹Ø©</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart_items %}
            <tr id="item-row-{{ item.id }}">
              <td>{{ item.perfume_size.perfume.name_ar }}</td>
              <td>{{ item.perfume_size.size_ml }} Ù…Ù„</td>
              <td>
                <div class="d-flex justify-content-center align-items-center">
                  <button class="btn btn-sm btn-outline-secondary update-quantity" data-action="decrease" data-item-id="{{ item.id }}">-</button>
                  <span class="mx-2 quantity-value" id="quantity-{{ item.id }}">{{ item.quantity }}</span>
                  <button class="btn btn-sm btn-outline-secondary update-quantity" data-action="increase" data-item-id="{{ item.id }}">+</button>
                </div>
              </td>
              <td id="item-total-{{ item.id }}">{{ item.total_price }} Ø¬Ù†ÙŠÙ‡</td>
              <td>
                <button class="btn btn-sm btn-danger remove-item" data-item-id="{{ item.id }}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <h4 class="mt-4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="total-price" style="color: #c19d56;">{{ total_price }} Ø¬Ù†ÙŠÙ‡</span></h4>

      <div class="mt-4">
        <a href="{% url 'home:home' %}" class="btn btn-outline-dark" style="border-color: #c19d56; color: #c19d56;">Ø­Ø¬Ø² Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</a>
        <a href="{% url 'home:booking' %}" class="btn" style="background-color: #c19d56; color: white;">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²</a>
      </div>
    </div>
  {% else %}
    <p style="color: #555;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
  {% endif %}

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©
    $('.update-quantity').click(function() {
      const itemId = $(this).data('item-id');
      const action = $(this).data('action');
      
      $.ajax({
        url: "{% url 'home:update_cart_quantity' %}",
        method: "POST",
        data: {
          'item_id': itemId,
          'action': action,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(data) {
          $(`#quantity-${itemId}`).text(data.new_quantity);
          $(`#item-total-${itemId}`).text(data.item_total + " Ø¬Ù†ÙŠÙ‡");
          $('#total-price').text(data.total_price + " Ø¬Ù†ÙŠÙ‡");

          if (data.new_quantity === 0) {
            $(`#item-row-${itemId}`).fadeOut(300, function() {
              $(this).remove();
            });
          }
        }
      });
    });

    // âœ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    $('.remove-item').click(function() {
      const itemId = $(this).data('item-id');
      
      $.ajax({
        url: "{% url 'home:remove_cart_item' %}",
        method: "POST",
        data: {
          'item_id': itemId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(data) {
          $(`#item-row-${itemId}`).fadeOut(300, function() {
            $(this).remove();
          });
          $('#total-price').text(data.total_price + " Ø¬Ù†ÙŠÙ‡");
        }
      });
    });

  });
</script>
{% endblock body %}